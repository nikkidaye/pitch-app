{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nclass SyncEntity {\n  constructor(services, removalHandler) {\n    this.services = services;\n    this.removalHandler = removalHandler;\n    this.subscriptionState = 'none';\n    this._attachedListeners = new Map();\n  }\n\n  _advanceLastEventId(eventId, revision) {}\n\n  reportFailure(err) {\n    if (err.status === 404) {\n      // assume that 404 means that entity has been removed while we were away\n      this.onRemoved(false);\n    } else {\n      this.broadcastEventToListeners('failure', err);\n    }\n  }\n  /**\n   * Subscribe to changes of data entity\n   * @private\n   */\n\n\n  _subscribe() {\n    this.services.router.subscribe(this.sid, this);\n  }\n  /**\n   * Unsubscribe from changes of current data entity\n   * @private\n   */\n\n\n  _unsubscribe() {\n    this.services.router.unsubscribe(this.sid);\n  }\n\n  _setSubscriptionState(newState) {\n    this.subscriptionState = newState;\n    this.broadcastEventToListeners('_subscriptionStateChanged', newState);\n  }\n  /**\n   * @public\n   */\n\n\n  close() {\n    this._unsubscribe();\n\n    if (this.removalHandler != null) {\n      this.removalHandler(this.type, this.sid, this.uniqueName);\n    }\n  }\n\n  attach(closeable) {\n    const uuid = closeable.listenerUuid;\n\n    const existingRecord = this._attachedListeners.get(uuid);\n\n    if (existingRecord) {\n      return;\n    }\n\n    if (!this._attachedListeners.size) {\n      // the first one to arrive\n      this._subscribe();\n    }\n\n    this._attachedListeners.set(uuid, closeable);\n  }\n\n  detach(listenerUuid) {\n    this._attachedListeners.delete(listenerUuid);\n\n    if (!this._attachedListeners.size) {\n      // last one out, turn off lights, shut the door\n      this.close(); // invokes unsubscribe and removal handler\n    }\n  }\n\n  broadcastEventToListeners(eventName, args) {\n    for (let listener of this._attachedListeners.values()) {\n      listener.emit(eventName, args);\n    }\n  }\n\n}\n\nexports.SyncEntity = SyncEntity;\nexports.default = SyncEntity;","map":null,"metadata":{},"sourceType":"script"}